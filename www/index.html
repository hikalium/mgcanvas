<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=9">
<meta charset="UTF-8">
<meta name="viewport" content="user-scalable=no">
<title>Mind Graph Canvas</title>
<script src="http://use.edgefonts.net/source-code-pro.js"></script>

<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="./css/mgcanvas.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="./mgcanvas.min.js" charset="UTF-8"></script>
<script type="text/javascript">

var mgc;
var mgdb;
var mgp;
onload = function() {
	var f = function(a){ return document.getElementById(a); };
	// init MGCanvas
	mgdb = new MGDatabase();
	mgc = new MGCanvas(mgdb, f("mainCanvas"), true);
	mgp = new MGProlog(mgdb);
	// for full screen
	var div_canvas = document.getElementById('canvaswrapper');
	var resizef = function(){
		mgc.resizeTo(div_canvas.clientWidth, div_canvas.clientHeight);
	};
	addEvent(window, "resize", resizef);
	resizef();
	//
/*
	mgdb.addAtom("A");
	mgdb.addAtom("B");
	mgdb.addAtom("C");
	mgdb.addAtom("D");
	mgdb.addAtom("E");
	mgdb.addAtom("F");
	mgdb.addAtom("G");
	mgdb.addAtom("H");
*/
	//
	var commandBox = document.getElementById("commandBox");
	commandBox.onkeydown = function(e){
		// press Enter to send
		// Shift+Enter for new line
		if(e.keyCode == 13){ // Enter
			if(!e.shiftKey){
				if(commandBox.value.length){
					if(!this.history){
						this.history = new Array();
					}
					this.history.push(commandBox.value);
					mgp.exec(commandBox.value);
				}
				commandBox.value = '';
				e.preventDefault();
			}
		} else if(e.keyCode == 38){	//Up
			if(this.history && this.history.length > 0){
				if(this.historyIndex === undefined || commandBox.value != this.history[this.historyIndex]){
					this.historyIndex = this.history.length - 1;
				} else if(this.historyIndex > 0){
					this.historyIndex--;
				}
				commandBox.value = this.history[this.historyIndex];
			}
		}
	}
	// init D&D
	var dropZone = commandBox;
	dropZone.addEventListener('dragover', handleDragOver, false);
	dropZone.addEventListener('drop', handleFileSelect, false);
	// search box
	var searchBox = document.getElementById("searchBox");
	var searchButton = document.getElementById("searchButton");
	searchButton.onclick = function(){
		mgc.focusToElementByContents(searchBox.value);
	}
}

function addNode(){
	var eid = mgdb.addAtom();
	for(var i = 0; i < mgc.nodeSelectionList.length; i++){
		mgdb.addRelation(UUID.nullUUID, [eid, mgc.nodeSelectionList[i].elementID]);
	}
}

function connectNode(){
	var eidList = mgc.nodeSelectionList.propertiesNamed("elementID");
	mgdb.addRelation(UUID.nullUUID, eidList);
}

function updateNode(){
	var nl = mgc.nodeSelectionList;
	if(!nl.length){
		alert("Plese select at least 1 node.");
		return;
	}
	if(nl.length > 1 && !window.confirm('This operation will affect ' + nl.length + 'nodes. Is this ok?')){
		return;
	}
	var retv = window.prompt("Set contents:", "");
	if(retv && retv.length){
		for(i = 0; i < nl.length; i++){
			mgdb.updateAtomElement(nl[i], retv);
		}
	}
}

function splitByLength(str, length) {
    var resultArr = [];
    if (!str || !length || length < 1) {
        return resultArr;
    }
    var index = 0;
    var start = index;
    var end = start + length;
    while (start < str.length) {
        resultArr[index] = str.substring(start, end);
        index++;
        start = end;
        end = start + length;
    }
    return resultArr;
}

// http://www.html5rocks.com/ja/tutorials/file/dndfiles/
function handleFileSelect(evt){
	evt.stopPropagation();
	evt.preventDefault();

	var files = evt.dataTransfer.files; // FileList object.
	
	// files is a FileList of File objects. List some properties.
	var output = [];
	for(var i = 0, f; f = files[i]; i++){
		var r = new FileReader();
		r.onload = (function(file){
			return function(e){
				var list = r.result.split("\n");
				var strRep = "";
				for(var k = 0; k < list.length; k++){
					var splist = list[k].split(" ");
					if(splist[1] === "3"){
						// String
						var s = "#" + UUID.convertFromHexString(splist[0]);
						var sblist = splitByLength(splist[3], 2);
						var ss = "";
						var sslen = parseInt(splist[2]) - 1;
						for(var t = 0; t < sslen; t++){
							ss += String.fromCharCode(parseInt(sblist[t], 16));
						}
						s += " " + encodeURIComponent(ss);
						strRep += s + "\n";
					} else if(splist[1] === "4"){
						// Integer
						var s = "#" + UUID.convertFromHexString(splist[0]) +
						 " " + encodeURIComponent(parseInt(splist[3]))
						strRep += s + "\n";
					}
					
				}
				for(var k = 0; k < list.length; k++){
					var splist = list[k].split(" ");
					if(splist[1] === "1"){
						var idList = [];
						idList[0] = UUID.convertFromHexString(splist[0]);
						idList[1] = UUID.convertFromHexString(splist[3]);
						idList[2] = UUID.convertFromHexString(splist[4]);
						idList[3] = UUID.convertFromHexString(splist[2]);
						for(var t = 1; t < 4; t++){
							if(!mgdb.getElementByID(idList[t])){
								var s = "#" + idList[t] + "  ";
								strRep += s + "\n";
							}
						}
						var s = "$" + idList[0] +
							" #" + idList[1] + 
							" #" + idList[2] +
							" #" + idList[3]
							strRep += s + "\n";
					}
					
				}
				var nslist = strRep.split("\n");
				var nlist = [];
				for(var k = 0; k < nslist.length; k++){
					nlist[k] = mgdb.addElementFromStringRepresentation(nslist[k]);
					console.log(mgdb.getElementByID(nlist[k]));
				}
/*
				console.log(strRep);
				console.log(nlist);
*/
			}
		})(f);
		r.readAsText(f);
	}
}

function handleDragOver(evt){
	evt.stopPropagation();
	evt.preventDefault();
	evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}

</script>
</head>
<body ontouchmove="event.preventDefault()">
<div class="navbar navbar-fixed-top" role="navigation">
	<div class="container-fluid">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">MindGraphCanvas <small>by hikalium</small></a>
		</div>
		<div>
			<form class="navbar-form navbar-left" role="search" onsubmit="return false;">
				<input id="searchBox" type="text" class="form-control" placeholder="Search Node">
				<button id="searchButton" class="btn btn-default"><span class="glyphicon glyphicon-search"></span> Search</button>
			</form>
			<button class="btn btn-default navbar-btn" onclick="mgc.zoomIn();"><span class="glyphicon glyphicon-zoom-in"></span></button>
			<button class="btn btn-default navbar-btn" onclick="mgc.zoomOut();"><span class="glyphicon glyphicon-zoom-out"></span></button>
			<button class="btn btn-default navbar-btn" onclick="mgc.bringToCenter();"><span class="glyphicon glyphicon-screenshot"></span></button>
			<button class="btn btn-default navbar-btn" onclick="mgc.isPaused = true;"><span class="glyphicon glyphicon-pause"></span></button>
			<button class="btn btn-default navbar-btn" onclick="mgc.isPaused = false;"><span class="glyphicon glyphicon-play"></span></button>
			<button class="btn btn-default navbar-btn" onclick="addNode();"><span class="glyphicon glyphicon-plus"></span></button>
			<button class="btn btn-default navbar-btn" onclick="connectNode();"><span class="glyphicon glyphicon-link"></span></button>
			<button class="btn btn-default navbar-btn" onclick="updateNode();"><span class="glyphicon glyphicon-pencil"></span></button>
		</div>
	</div>
</div>

<div id="canvaswrapper">
	<canvas id="mainCanvas"></canvas>
	<textarea id="commandBox" placeholder="Input command here..."></textarea>
</div>

</body>
</html>
